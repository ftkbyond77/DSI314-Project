<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Planning in Progress</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen p-8">
    <div class="max-w-2xl mx-auto">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h1 class="text-3xl font-bold text-gray-800 text-center">ü§ñ AI Planning in Progress</h1>
            <p class="text-gray-600 text-center mt-2">Please wait while our AI agents analyze your documents...</p>
        </div>
        
        <!-- Progress Container -->
        <div class="bg-white rounded-lg shadow-lg p-8">
            <!-- Status Message -->
            <div id="statusMessage" class="text-center mb-6">
                <div class="inline-block animate-spin text-6xl mb-4">‚è≥</div>
                <h2 class="text-xl font-semibold text-gray-800" id="statusText">Initializing AI agents...</h2>
                <p class="text-gray-600 mt-2" id="detailText">Task ID: {{ task_id }}</p>
            </div>
            
            <!-- Progress Bar -->
            <div class="mb-6">
                <div class="flex justify-between text-sm text-gray-600 mb-2">
                    <span id="progressLabel">Starting...</span>
                    <span id="progressPercent">0%</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-4">
                    <div id="progressBar" class="bg-gradient-to-r from-blue-600 to-indigo-600 h-4 rounded-full transition-all duration-500" style="width: 0%"></div>
                </div>
            </div>
            
            <!-- Processing Details -->
            <div class="bg-gray-50 rounded-lg p-4 mb-6">
                <h3 class="font-semibold text-gray-800 mb-3">üìä Processing Details:</h3>
                <div class="space-y-2 text-sm text-gray-700">
                    <div class="flex justify-between">
                        <span>Files to analyze:</span>
                        <span class="font-semibold">{{ params.file_count }}</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Your goal:</span>
                        <span class="font-semibold">{{ params.user_goal }}</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Available time:</span>
                        <span class="font-semibold">{{ params.available_hours }} hours/week</span>
                    </div>
                    {% if params.constraints %}
                    <div class="flex justify-between">
                        <span>Constraints:</span>
                        <span class="font-semibold">{{ params.constraints }}</span>
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Agent Activity Log -->
            <div class="bg-blue-50 rounded-lg p-4">
                <h3 class="font-semibold text-blue-900 mb-3">üîß Agent Activity:</h3>
                <div id="activityLog" class="space-y-2 text-sm text-blue-800 max-h-40 overflow-y-auto">
                    <div class="flex items-start">
                        <span class="mr-2">‚öôÔ∏è</span>
                        <span>Task queued and waiting for processing...</span>
                    </div>
                </div>
            </div>
            
            <!-- Error Display (hidden by default) -->
            <div id="errorContainer" class="hidden mt-6 bg-red-50 border border-red-200 rounded-lg p-4">
                <h3 class="font-semibold text-red-800 mb-2">‚ùå Error Occurred:</h3>
                <p id="errorMessage" class="text-red-700 text-sm"></p>
                <button onclick="window.location.href='{% url 'upload_page_optimized' %}'" 
                        class="mt-4 bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700">
                    Try Again
                </button>
            </div>
        </div>
        
        <!-- Info Box -->
        <div class="mt-6 bg-white rounded-lg shadow p-4">
            <h3 class="font-semibold text-gray-800 mb-2">üí° What's Happening:</h3>
            <ul class="text-sm text-gray-700 space-y-1">
                <li>‚úì <strong>Prioritization Agent:</strong> Analyzing each document's importance</li>
                <li>‚úì <strong>Scheduling Agent:</strong> Creating your optimal study schedule</li>
                <li>‚úì <strong>Reasoning Engine:</strong> Generating explanations for each decision</li>
            </ul>
        </div>
    </div>
    
    <script>
        const taskId = '{{ task_id }}';
        let pollInterval;
        let activityLog = [];
        
        function addActivity(message) {
            activityLog.push(message);
            const logContainer = document.getElementById('activityLog');
            const div = document.createElement('div');
            div.className = 'flex items-start';
            div.innerHTML = `<span class="mr-2">‚öôÔ∏è</span><span>${message}</span>`;
            logContainer.appendChild(div);
            logContainer.scrollTop = logContainer.scrollHeight;
        }
        
        function updateProgress(current, total, status) {
            const percent = Math.round((current / total) * 100);
            document.getElementById('progressBar').style.width = percent + '%';
            document.getElementById('progressPercent').textContent = percent + '%';
            document.getElementById('progressLabel').textContent = status;
            document.getElementById('statusText').textContent = status;
        }
        
        function showError(message) {
            document.getElementById('errorContainer').classList.remove('hidden');
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('statusMessage').classList.add('hidden');
            clearInterval(pollInterval);
        }
        
        function checkStatus() {
            fetch(`/api/planning-status/${taskId}/`)
                .then(response => response.json())
                .then(data => {
                    console.log('Status:', data);
                    
                    if (data.status === 'PENDING') {
                        updateProgress(0, 3, 'Task queued...');
                        addActivity('Waiting in queue...');
                    }
                    else if (data.status === 'PROCESSING') {
                        const meta = data.meta || {};
                        const current = meta.current || 1;
                        const total = meta.total || 3;
                        const status = meta.status || 'Processing...';
                        
                        updateProgress(current, total, status);
                        addActivity(status);
                    }
                    else if (data.ready) {
                        clearInterval(pollInterval);
                        
                        if (data.success) {
                            updateProgress(3, 3, 'Complete! Redirecting...');
                            addActivity('‚úÖ Planning completed successfully!');
                            
                            // Show summary
                            if (data.tool_summary) {
                                addActivity(`üìä Used ${data.tool_summary.total_calls} tool calls in ${data.execution_time}s`);
                            }
                            
                            setTimeout(() => {
                                window.location.href = '{% url 'result_page_optimized' %}';
                            }, 2000);
                        } else {
                            showError(data.error || 'Unknown error occurred');
                        }
                    }
                    else if (data.status === 'FAILURE') {
                        showError(data.error || 'Task failed');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showError('Failed to check status: ' + error.message);
                });
        }
        
        // Start polling
        checkStatus();
        pollInterval = setInterval(checkStatus, 2000); // Check every 2 seconds
        
        // Timeout after 5 minutes
        setTimeout(() => {
            clearInterval(pollInterval);
            if (!document.getElementById('errorContainer').classList.contains('hidden')) {
                return; // Already showing error
            }
            showError('Processing timeout. Your task may still be running in the background.');
        }, 300000);
    </script>
</body>
</html>